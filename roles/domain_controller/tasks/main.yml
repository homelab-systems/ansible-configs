---
#required
#domain
#primary_dns
#domain_admin_user
#domain_admin_password
#safe_mode_password
- name: install windows features
  win_feature:
    name: "{{item}}"
    include_sub_features: yes
    include_management_tools: yes
    state: present
  with_items:
    - AD-Domain-Services
    - DNS

- name: create windows domain
  win_domain:
    dns_domain_name: "{{domain}}"
    safe_mode_password: "{{safe_mode_password}}"
  register: domain_create

- name: ensure domain controllers
  win_domain_controller:
    dns_domain_name: "{{domain}}"
    domain_admin_password: "{{domain_admin_password}}"
    domain_admin_user: "{{domain_admin_user}}"
    safe_mode_password: "{{safe_mode_password}}"
    state: domain_controller
  register: domain_controller

- name: set dns when not pdc
  win_dns_client:
    adapter_names: "*"
    ipv4_addresses:
      - "{{primary_dns}}"
      - "{{static_ip}}"
      - 127.0.0.1
  when: pdc.lower() != "y"

- name: set dns when pdc
  win_dns_client:
    adapter_names: "*"
    ipv4_addresses:
      - "{{static_ip}}"
      - 127.0.0.1
  when: pdc.lower() == "y"

- name: reboot if required
  win_reboot:
  when: domain_create.reboot_required == True or domain_controller.reboot_required == True