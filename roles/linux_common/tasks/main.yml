---
#required variables:
#domain_joined
#host_name
#
#optional variables:
#join_user
#computer_ou
#join_password

- name: change hostname
  hostname: 
    name: "{{host_name}}"

- name: add admin user
  user:
    name: administrator
    groups: wheel
    append: yes

- name: add ssh key for admin user
  authorized_key:
    user: administrator
    state: present
    key: "{{item}}"
  with_items:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0gaDkB9pbqRP6M9+K8sl6V9f1jkcZJAdogn1qS59bV372FNLtVKJB9FBZyUttjfhrruiV+ZZok2i2u07br9L5S6ARKPxzIitzrtQuvsbGtDwJtOrXsgMn4hQe+7x9JCGlOQ+xbmniC2MiCUbUTlBCDNA+TAaH9XnoRMyWUyVUJbU+u9zlcT+8OC6wvEk0GxjukcNuwiANuvfjjiow9e3qA1wUQukLGjSWDufWLp9hJMKkVHQ1m9I/Yw84LejBKq4YizhfjMah9yoq7KrnzURkO6i2T6aSYT/1APWm+jw9iOH9VP+xbVD9RAMFvb49yU11rLVgS3e/+tdosZIRtFYJ pbove-pub
  
- name: install epel-release
  yum:
    name: epel-release
    state: present
    update_cache: yes

- name: install base packages
  yum:
    name: "{{item}}"
    state: present
    update_cache: yes
  with_items:
    - sssd
    - sssd-ad
    - python2
    - python2-pip
    - python34
    - python34-pip
    - realmd
    - oddjob
    - oddjob-mkhomedir
    - chrony
  when: ansible_distribution == "CentOS"

- name: install python packages
  pip:
    name: "{{item}}"
    state: present
    executable: pip3
  with_items:
    - sh

- name: copy hosts file
  template:
    src: hosts
    dest: /etc/hosts

- name: copy ntp config
  copy: 
    src: chrony.conf
    dest: /etc/chrony.conf
  notify: ensure_ntpd

- name: join domain
  command: >
    echo "{{domain_password}}" | realm join -U {{domain_user}} --computer-OU {{computer_ou}} 
    --unattended --install=/
  args:
    creates: /etc/sssd/sssd.conf
  when: domain_joined == "y"

- name: set gpo enforcing
  lineinfile:
    path: /etc/sssd/sssd.conf
    insertafter: "^[domain"
    line: ad_gpo_access_control = enforcing
  notify: ensure_sssd
  when: domain_joined == "y"

- name: copy sudoers files for domain groups/users
  copy: 
    src: "{{item}}"
    dest: /etc/sudoers.d/
    mode: 0440
  with_items:
    - unix-wheel
  when: domain_joined == "y"

- name: copy ifcfg-eth0 config
  template:
    src: ifcfg-eth0
    dest: /etc/sysconfig/network-scripts/ifcfg-eth0

- name: copy sshd config
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
  notify: ensure_sshd