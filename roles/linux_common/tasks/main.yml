---
#required variables:
#domain_joined
#host_name
#
#optional variables:
#join_user
#computer_ou
#join_password

- name: copy sudoers
  copy:
    src: sudoers
    dest: /etc/sudoers

- name: change hostname
  hostname: 
    name: "{{host_name}}"

- name: add admin user
  user:
    name: admin
    groups: wheel
    append: yes

- name: add ssh key for admin user
  authorized_key:
    user: admin
    state: present
    key: "{{item}}"
  with_items:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqnl1fAQ+bu2SoXJNi+1i4fn4cQr9NYusoDu6KTVwq3PBWySkR9YBt4poiElTFPEumYo6Zd9fZ0jUXTv+55TcjIGNlm1gXg5IXGag1RfAXXUzcFSgL5iBMx2xjxJkqiDaLYHtvuy+RTmrkOmF3OB+wTFT8oxj1tLXkcjGcMhKuqjDmXTvSuQG/BowLvLdnhBUzJVh0J7d1iElrrVJ/M2trP70MVWPuiF2T2j105zKsQGT733jR9GgI/uxmlv4e3B6xnSRInWL6VaX6u/i7oG2IBOOaBlOSPu53JhRWVqQZ7DdZj9pUpKLU+PuL14/SV4N4c9LRG3/Ylq2sXQAwfmDF pbove-pub
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCipp3Kb/qJ/fbi01zbPbURbSjJil79+2HVabpvV1BMZhaHXZD7s9FYcj//FmaNvburWuNV5UDn/2gHxP7JyutgfPUyI67x7j83+shZWHDNAIs7sMy9B3EBIZgZ/FvxkL7rGa1IoEzB60mIgmLdydt+oNgjdcEFToXeK+2hA397LdTvTt5SB57zL3HUKCI7bPZp9eHJ+UDFSdeUFOxOsTcf1D8iY5qk+imswy83HjvC1xcfVd3ySMBKei5Zn7a6Ie1SqmvxUTNc6DVAPx3a/Fg6svnRmDY1gvzc89pCle8C1XZh0pL25dLSV8gYOCCifw8DCJrj5EMnqMEzJxc1mWR7 pbove@ammo-box

- name: install epel-release
  yum:
    name: epel-release
    state: present
    update_cache: yes

- name: install base packages
  yum:
    name: "{{item}}"
    state: present
    update_cache: yes
  with_items:
    - realmd
    - python2
    - python2-pip
    - python34
    - python34-pip
    - chrony
    - libselinux-python
    - libsemanage-python
    - screen
    - wget
  when: ansible_distribution == "CentOS"
  notify: ensure_ntpd

- name: install python packages
  pip:
    name: "{{item}}"
    state: present
    executable: pip3
  with_items:
    - sh
    - pexpect

- name: install python2 pexpect
  pip:
    name: pexpect
    state: present
    executable: pip2

- name: copy hosts file
  template:
    src: hosts
    dest: /etc/hosts

- name: join domain
  shell: >
    realm join --user="{{domain_user}}" --computer-ou="{{}}"
  args:
    creates: /etc/sssd/sssd.conf
  when: domain_joined == "y"

- name: copy ifcfg-eth0 config
  template:
    src: ifcfg-eth0
    dest: /etc/sysconfig/network-scripts/ifcfg-eth0
  register: ip_change

- name: copy sshd config
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
  notify: ensure_sshd


- name: configure firewall
  firewalld:
    service: ssh
    permanent: true
    state: enabled
  notify: ensure_firewalld