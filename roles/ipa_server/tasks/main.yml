---

- name: install packages
  yum: 
    name: "{{item}}"
    state: present
  with_items:
    - freeipa-server
    - ipa-server-dns
    - haveged
  register: ipa_servers

- name: start and enable haveged
  service:
    name: haveged
    state: started
    enabled: yes
    use: service

- name: set firewall
  firewalld:
    service: "{{item}}"
    state: enabled
    permanent: yes
  with_items:
    - freeipa-ldaps
    - freeipa-ldap
    - freeipa-replication
    - kerberos
    - https
    - http
    - dns
    - ntp
    - kpasswd

- name: add static ip
  command: ip addr add {{static_ip}}/24 dev eth0
  when: ipa_servers.changed

- name: configure ipa server
  command: >
    ipa-server-install --ds-password="{{dirman_password}}" --admin-password="{{admin_password}}" --domain="{{domain}}"
    --realm="{{domain | upper}}" --ip-address="{{static_ip}}" --setup-dns --no-forwarders --no-host-dns --auto-reverse -U --allow-zone-overlap
  when: replica.lower() == "n" and ipa_servers.changed

- name: configure ip_server replica
  command: ipa-replica-install --ip-address="{{static_ip}}" --admin-password="{{admin_password}}" --setup-ca --setup-dns --no-forwarders -U
  when: replica.lower() == "y" and ipa_servers.changed