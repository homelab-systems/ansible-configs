---
#requires:
#dns_servers
#host_name
#domain

- name: computer name if  domain unspecificied
  script: win_hostname.ps1 -hostname "{{host_name}}"
  register: win_rename
  when: domain_joined.lower() != "y"

- name: set time zone
  win_timezone:
    timezone: Eastern Standard Time

- name: check ntp config
  win_command: w32tm /query /source
  register: time_servers
  when: domain_joined.lower() != "y"

- name: setup ntp
  win_command: w32tm  /config /syncfromflags:manual /manualpeerlist:"0.us.pool.ntp.org 1.us.pool.ntp.org 2.us.pool.ntp.org 3.us.pool.ntp.org" /reliable:yes
  when: domain_joined != "y"
  notify: ensure_ntp

- name: restart if changed
  win_reboot:
  when: domain_joined.lower() != "y" and win_rename.stdout.strip() == "changed"

- name: setup dns servers
  win_dns_client:
    adapter_names: "*"
    ipv4_addresses: "{{dns_servers}}"

- name: install chocolatey
  win_chocolatey:
    name: chocolatey
    state: latest

- name: remove windows smb1
  win_feature:
    name: FS-SMB1
    state: absent

- name: join domain
  win_domain_membership:
    dns_domain_name: "{{domain}}"
    domain_admin_user: "{{domain_user}}@{{domain}}"
    domain_admin_password: "{{domain_password}}"
    hostname: "{{host_name}}"
    domain_ou_path: "{{config_ou}}"
    state: domain
  register: domain_join
  when: domain_joined.lower() == "y"

- name: restart if required
  win_reboot:
  when: domain_joined.lower() == "y" and domain_join.reboot_required